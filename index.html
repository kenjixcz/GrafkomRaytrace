<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Ray Tracing Dasar - Perpotongan Bola</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            font-family: sans-serif;
        }
        canvas {
            border: 1px solid black;
            background-color: #ffffff;
        }
        #container {
            text-align: center;
        }
        h1 {
           margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="container">
         <h1>Demo Ray Tracing Dasar (Perpotongan Bola)</h1>
         <canvas id="raytraceCanvas" width="500" height="500"></canvas>
    </div>

    <script id="vector-helpers">
        // --- Fungsi Bantuan Vektor ---

        // Pengurangan dua vektor (a - b)
        function vecSubtract(a, b) {
            return { x: a.x - b.x, y: a.y - b.y, z: a.z - b.z };
        }

        // Perkalian dot dua vektor
        function vecDot(a, b) {
            return a.x * b.x + a.y * b.y + a.z * b.z;
        }

        // Menghitung panjang (magnitude) vektor
        function vecLength(a) {
            return Math.sqrt(vecDot(a, a));
        }

        // Normalisasi vektor (membuat panjangnya menjadi 1)
        function vecNormalize(a) {
            const len = vecLength(a);
            if (len === 0) return { x: 0, y: 0, z: 0 }; // Hindari pembagian dengan nol
            return { x: a.x / len, y: a.y / len, z: a.z / len };
        }
    </script>

    <script id="raytracer-logic">
        // --- Konfigurasi & Inisialisasi ---
        const canvas = document.getElementById('raytraceCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        // Definisi Bola
        const sphere = {
            center: { x: 0, y: 0, z: 5 }, // Posisi tengah bola di depan kamera
            radius: 1.5,                  // Jari-jari bola
            color: { r: 255, g: 0, b: 0 } // Warna bola (merah)
        };

        // Definisi Kamera (Mata)
        const camera = {
            origin: { x: 0, y: 0, z: 0 } // Posisi kamera di titik origin
        };

        // Warna Latar Belakang
        const backgroundColor = { r: 100, g: 149, b: 237 }; // Cornflower blue

        // --- Fungsi Ray-Sphere Intersection ---
        // Mengembalikan nilai t (jarak) jika ada perpotongan, atau null jika tidak.
        function intersectSphere(rayOrigin, rayDirection, sphere) {
            const oc = vecSubtract(rayOrigin, sphere.center); // Vektor dari pusat bola ke asal sinar
            const a = vecDot(rayDirection, rayDirection); // Harus 1 jika rayDirection dinormalisasi
            const b = 2.0 * vecDot(oc, rayDirection);
            const c = vecDot(oc, oc) - sphere.radius * sphere.radius;
            const discriminant = b * b - 4 * a * c;

            if (discriminant < 0) {
                return null; // Tidak ada perpotongan nyata
            } else {
                // Mengembalikan jarak ke titik perpotongan terdekat
                const t = (-b - Math.sqrt(discriminant)) / (2.0 * a);
                 // Kita hanya tertarik pada perpotongan di depan kamera (t > 0)
                if (t > 0.001) { // Gunakan epsilon kecil untuk menghindari self-intersection
                   return t;
                }
                // Cek perpotongan kedua jika yang pertama di belakang
                const t2 = (-b + Math.sqrt(discriminant)) / (2.0 * a);
                 if (t2 > 0.001) {
                    return t2;
                 }
                return null; // Kedua perpotongan di belakang atau tepat di origin
            }
        }

        // --- Proses Rendering ---
        function render() {
            console.time("Render Time"); // Mulai timer
            const imageData = ctx.createImageData(canvasWidth, canvasHeight);
            const data = imageData.data;

            for (let y = 0; y < canvasHeight; y++) {
                for (let x = 0; x < canvasWidth; x++) {
                    // 1. Konversi koordinat piksel (x, y) ke koordinat world space (-1 to 1)
                    //    (0,0) di canvas adalah kiri atas, kita ingin (0,0) di tengah
                    //    Kita asumsikan view plane berada di z=1
                    const Px = (2 * (x + 0.5) / canvasWidth - 1) * (canvasWidth / canvasHeight); // Koreksi aspek rasio
                    const Py = (1 - 2 * (y + 0.5) / canvasHeight);
                    const Pz = 1; // Jarak view plane dari kamera

                    // 2. Hitung arah sinar (ray direction) dari kamera ke piksel
                    const rayDirectionWorld = { x: Px, y: Py, z: Pz }; // Arah relatif thd kamera
                    // Vektor arah dari origin kamera ke titik di view plane
                    const rayDirection = vecNormalize(vecSubtract(rayDirectionWorld, camera.origin)); // Normalisasi arah sinar

                    // 3. Cek perpotongan sinar dengan bola
                    const intersection = intersectSphere(camera.origin, rayDirection, sphere);

                    // 4. Tentukan warna piksel
                    let pixelColor = backgroundColor;
                    if (intersection !== null) {
                        pixelColor = sphere.color; // Jika berpotongan, gunakan warna bola
                    }

                    // 5. Set data warna piksel (RGBA)
                    const index = (y * canvasWidth + x) * 4;
                    data[index]     = pixelColor.r; // Red
                    data[index + 1] = pixelColor.g; // Green
                    data[index + 2] = pixelColor.b; // Blue
                    data[index + 3] = 255;          // Alpha (opaque)
                }
            }

            // Gambar hasil ke canvas
            ctx.putImageData(imageData, 0, 0);
            console.timeEnd("Render Time"); // Akhiri timer dan tampilkan durasi
            console.log("Rendering selesai.");
        }

        // --- Mulai Rendering ---
        render();

    </script>
</body>
</html>
